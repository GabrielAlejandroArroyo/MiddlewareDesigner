<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquitectura General - Middleware Designer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { background: #212529; min-height: 100vh; color: white; padding: 20px; position: fixed; width: 250px; }
        .content { margin-left: 270px; padding: 40px; }
        .nav-link { color: #adb5bd; }
        .nav-link:hover { color: white; }
        .nav-link.active { color: #0dcaf0; font-weight: bold; }
        pre { background: #f1f1f1; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h4 class="mb-4 text-info">MD Docs</h4>
        <ul class="nav flex-column">
            <li class="nav-item mb-2"><a class="nav-link" href="../index.html"><i class="bi bi-house-door me-2"></i>Inicio</a></li>
            <li class="nav-item mb-2"><a class="nav-link active" href="general.html"><i class="bi bi-diagram-3 me-2"></i>Arquitectura</a></li>
            <li class="nav-item mb-2"><a class="nav-link" href="modelos_datos.html"><i class="bi bi-database me-2"></i>Modelos de Datos</a></li>
            <li class="nav-item mb-2"><a class="nav-link" href="../servicios/catalogo.html"><i class="bi bi-box me-2"></i>Servicios</a></li>
            <li class="nav-item mb-2"><a class="nav-link" href="../middleware/README.html"><i class="bi bi-cpu me-2"></i>Middleware</a></li>
            <li class="nav-item mb-2"><a class="nav-link" href="../frontend/README.html"><i class="bi bi-window me-2"></i>Frontend</a></li>
        </ul>
    </div>
    <div class="content">
        <h1 class="mb-4 text-dark">Arquitectura General del Sistema</h1>
        <p class="lead">Este documento describe la arquitectura técnica, flujos de datos y componentes robustos del ecosistema <strong>Middleware Designer</strong>.</p>

        <h2 class="mt-5 mb-3">1. Visión General (C4 Model - Nivel 1)</h2>
        <div class="card p-4 shadow-sm border-0 mb-4 bg-white">
            <div class="mermaid">
                graph TD
                    User((Usuario Final))
                    MFE[Microfrontend Designer UI]
                    MW[Middleware Designer]
                    DB_MW[(Middleware Config DB)]
                    
                    subgraph Microservicios Backend (FastAPI)
                        SVC_P[Servicio País]
                        SVC_PR[Servicio Provincia]
                        SVC_L[Servicio Localidad]
                        SVC_C[Servicio Corporación]
                    end

                    User --> MFE
                    MFE --> MW
                    MW --> DB_MW
                    MW -.->|Inspección Resiliente OpenAPI| SVC_P
                    MW -.->|Inspección Resiliente OpenAPI| SVC_PR
                    MW -.->|Inspección Resiliente OpenAPI| SVC_L
                    MW -.->|Inspección Resiliente OpenAPI| SVC_C
            </div>
        </div>

        <h2 class="mt-5 mb-3">2. Componentes Críticos</h2>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card h-100 p-3 border-0 shadow-sm">
                    <h5 class="text-primary fw-bold">Microservicios</h5>
                    <p class="small text-muted">Exponen contratos <strong>OpenAPI</strong> con soporte para monitoreo en tiempo real y CORS permisivo.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 p-3 border-0 shadow-sm">
                    <h5 class="text-success fw-bold">Orquestador (Middleware)</h5>
                    <p class="small text-muted">Parser resiliente que aplana jerarquías de herencia (<code>allOf</code>) y sanitiza metadatos automáticamente.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 p-3 border-0 shadow-sm">
                    <h5 class="text-info fw-bold">Microfrontend</h5>
                    <p class="small text-muted">UI robusta en Angular con blindaje de renderizado ante contratos incompletos.</p>
                </div>
            </div>
        </div>

        <h2 class="mt-5 mb-3">3. Flujo de Configuración de UI</h2>
        <div class="card p-4 shadow-sm border-0 mb-4 bg-white">
            <div class="mermaid">
                sequenceDiagram
                    participant Admin as Administrador
                    participant MFE as Designer UI
                    participant MW as Middleware
                    participant SVC as Microservicio

                    Admin->>MFE: Registra URL de Microservicio
                    MFE->>MW: POST /backend-services
                    MW->>SVC: GET /openapi.json
                    SVC-->>MW: Contrato OpenAPI (con herencia)
                    MW->>MW: Aplana modelos y Limpia caracteres
                    MW-->>MFE: DTOs Estructurados y Limpios
                    Admin->>MFE: Customiza Atributos (Labels, Orden)
                    Admin->>MFE: Pulsa "Limpiar Caché" si hay cambios
                    MFE->>MW: Refresco forzado de metadatos
                    MW-->>MFE: Atributos Técnicos Actualizados
            </div>
        </div>
    </div>
</body>
</html>
